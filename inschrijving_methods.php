<?phpinclude_once("include_helperMethods.php");include_once("include_globalVars.php");setlocale(LC_TIME, 'nl_NL');function deleteReservation($database_host, $database_user, $database_pass, $database, $opzoektabel, $res_id) {	$bisdblink = mysql_connect($database_host, $database_user, $database_pass);	if (!mysql_select_db($database, $bisdblink)) {		echo "Fout: database niet gevonden.<br>";		exit();	}		$returnText = "";	$email_to = "";	// haal gegevens niet uit form maar uit DB, om fraude te voorkomen	$query = "SELECT Email, Boot_ID, Datum, Begintijd FROM ".$opzoektabel." WHERE Volgnummer='$res_id';";	$result = mysql_query($query);	if ($result) {		$row = mysql_fetch_assoc($result);		$email_to = $row['Email'];		$boot_id = $row['Boot_ID'];		// bootnaam		$query_bootnaam = "SELECT Naam from boten WHERE ID=$boot_id;";		$result_bootnaam = mysql_query($query_bootnaam);		$row_bootnaam = mysql_fetch_assoc($result_bootnaam);		$boot = $row_bootnaam['Naam'];		//		$db_datum = $row['Datum'];		$date_tmp = strtotime($db_datum);		$date_sh = strftime('%A %d-%m-%Y', $date_tmp);		$starttijd = $row['Begintijd'];		$message = "Uw inschrijving van '$boot' op $date_sh vanaf ".substr($starttijd, 0, 5)." is zojuist uit BIS verwijderd.";	}	// the deleting itself	$returnText .= "<p>";	$query = "UPDATE ".$opzoektabel." SET Verwijderd=1 WHERE Volgnummer='$res_id';";	$result = mysql_query($query);	if (!$result) {		$returnText .= "Het verwijderen van de inschrijving is mislukt: ".mysql_error();	} else {		$returnText .= "De inschrijving is verwijderd.<br />NB: de gegevens zijn ter controle bewaard.";		if (SendEmail($email_to, "Verwijdering inschrijving", $message)) {			$returnText .= "<br />NB: er is ter controle een e-mail gestuurd aan de oorspronkelijke inschrijver.";		}	}	$returnText .= "</p>";		mysql_close($bisdblink);		return $returnText;}function makeReservation($database_host, $database_user, $database_pass, $database, $opzoektabel, &$fail_msg, $from_api, $id, $again, $boat_id, $name, $team_name, $email, $mpb, $date, $start_time_hrs, $start_time_mins, $end_time_hrs, $end_time_mins, $ergo_lo = 0, $ergo_hi = 0) {		global $koudwaterprotocol;	global $today_db;	global $thehour;	global $theminute;	global $themonth;		$NR_OF_CONCEPTS = 6; // LET OP: aanpassen als het aantal Concept-ergo's verandert! (ivm blokinschrijving)		$bisdblink = mysql_connect($database_host, $database_user, $database_pass);	if (!mysql_select_db($database, $bisdblink)) {		echo "Fout: database niet gevonden.<br>";		exit();	}		$fail_msg = "";	$returnText = "";		// check persoonsnaam	if (!CheckName($name)) {		$fail_msg .= "U dient een geldige voor- en achternaam op te geven. Let op: de apostrof (') wordt niet geaccepteerd.<br />";	}	// email is niet verplicht, maar moet wel correct zijn	if ($email && !CheckEmail($email)) {		$fail_msg .= "U dient een geldig e-mailadres op te geven.<br />";	}	// check date	$date_db = 0;	if (!$date || !CheckTheDate($date) || ($mpb != "Societeit" && !InRange($date, 10))) {		$fail_msg .= "U dient een (geldige) inschrijfdatum op te geven, van vandaag tot over maximaal 10 dagen.<br />";	} else {		$date_db = DateToDBdate($date);		if (strtotime($date_db) < strtotime($today_db)) {			$fail_msg .= "Een inschrijving kan niet in het verleden plaatsvinden.<br />";		}	}	// check time	if (!is_numeric($start_time_hrs) || $start_time_hrs < 6 || $start_time_hrs > 23) {		$fail_msg .= "Ongeldig start-uur.<br />";	}	if (!is_numeric($end_time_hrs) || $end_time_hrs < 6 || $end_time_hrs > 23) {		$fail_msg .= "Ongeldig eind-uur.<br />";	}	if ($start_time_mins != "00" && $start_time_mins != "0" && $start_time_mins != "15" && $start_time_mins != "30" && $start_time_mins != "45") {		$fail_msg .= "Ongeldige start-minuten.<br />";	}	if ($end_time_mins != "00" && $end_time_mins != "0" && $end_time_mins != "15" && $end_time_mins != "30" && $end_time_mins != "45") {		$fail_msg .= "Ongeldige eind-minuten.<br />";	}	$start_time = $start_time_hrs.":".$start_time_mins;		$end_time = $end_time_hrs.":".$end_time_mins;		$duration = (($end_time_hrs - $start_time_hrs) * 60) + ($end_time_mins - $start_time_mins);	if ($duration <= 0) {		$fail_msg .= "De eindtijd van een inschrijving dient later dan de begintijd te zijn.<br />";	}	if ($date_db == $today_db && (($start_time_hrs < $thehour) || (($start_time_hrs == $thehour) && ($start_time_mins < $theminute)))) {		$fail_msg .= "Een inschrijving kan niet in het verleden beginnen.<br />";	}	// check ergo-blok	if (!is_numeric($ergo_lo) || !is_numeric($ergo_hi) || $ergo_lo < 0 || $ergo_lo > $NR_OF_CONCEPTS || $ergo_hi < 0 || $ergo_hi > $NR_OF_CONCEPTS) {		$fail_msg .= "Nummering van de Concept-ergometers klopt niet.<br />";	}	$ergo_range = $ergo_hi - $ergo_lo;	if ($ergo_range < 0) {		$fail_msg .= "Het blok moet lopen van de laagst- t/m de hoogst-genummerde Concept-ergometer.<br />";		$ergo_lo = 0;		$ergo_hi = 0;	}	// check boat	if (!is_numeric($boat_id) || $boat_id == 0) {		$boat = "";		$fail_msg .= "U heeft geen boot geselecteerd.<br />";	} else {		$query_bootnaam = "SELECT Naam FROM boten WHERE ID=$boat_id;";		$result_bootnaam = mysql_query($query_bootnaam);		$row_bootnaam = mysql_fetch_assoc($result_bootnaam);		$boat = $row_bootnaam['Naam'];	}	// cat. & grade bepalen n.a.v. boot die wordt ingeschreven	$query = "SELECT Roeigraad, `Type` FROM boten WHERE ID='" . $boat_id . "';";	$result = mysql_query($query);	if ($result) {		$row = mysql_fetch_assoc($result);		$grade = $row['Roeigraad'];		$type = $row['Type'];		$query2 = "SELECT Categorie FROM types WHERE `Type`='" . $type . "';";		$result2 = mysql_query($query2);		if ($result2) {			$row2 = mysql_fetch_assoc($result2);			$cat = $row2['Categorie'];		}	}	// check op uit de vaart	$query = "SELECT * FROM uitdevaart WHERE Verwijderd=0 AND Boot_ID='$boat_id' AND Startdatum<='$date_db' AND (Einddatum='0' OR Einddatum='0000-00-00' OR Einddatum>='$date_db');";	$result = mysql_query($query);	if (!$result) {		$returnText .= "Ophalen van Uit de Vaart-informatie mislukt.<br />";	} else {		$rows_aff = mysql_affected_rows($bisdblink);		if ($rows_aff > 0) $fail_msg .= "Deze boot is op deze dag uit de vaart.<br />";	}	// check MPB	// stop eerst alle MPB-gevende bestuursleden in een array	$mpb_array = array();	$query = "SELECT Functie FROM bestuursleden WHERE MPB=1;";	$result = mysql_query($query);	if (!$result) {		$returnText .= "Ophalen van bestuursleden mislukt.<br />";	}	while ($row = mysql_fetch_assoc($result)) {		array_push($mpb_array, $row['Functie']);	}	if ($mpb != "" && !in_array($mpb, $mpb_array)) {		$fail_msg .= "Onjuiste MPB-gever opgegeven.<br />";	}	$controle = 0;	if ($duration > 120) {		if ($mpb == "") $fail_msg .= "U schrijft voor langer dan 2 uur in. Hiervoor is MPB benodigd.<br />";		$controle = 1;	}	if (!InRange($date, 3)) {		 if ($mpb == "") $fail_msg .= "U schrijft meer dan 3 dagen vantevoren in. Hiervoor is MPB benodigd.<br />";		 $controle = 2;	}	if ($grade == "MPB") {		if ($mpb == "") $fail_msg .= "U schrijft een MPB-boot in. Hiervoor is MPB benodigd.<br />";		$controle = 3;	}		$fail_partial_cnt = 0;	$returnText .= "<p>";	for ($e = $ergo_lo; $e <= $ergo_hi; $e++) {	    // T.b.v. blokinschrijving ergometers (with normal reservation, ergo_lo = ergo_hi = e = 0)		$fail_partial = false;		if ($e > 0) {			$boat = "Concept ".$e;			$query_ergonaam = "SELECT ID FROM boten WHERE Naam='$boat';";			$result_ergonaam = mysql_query($query_ergonaam);			$row_ergonaam = mysql_fetch_assoc($result_ergonaam);			$boat_id = $row_ergonaam['ID'];		}		// Check inschrijving tegen de database		$query = "SELECT * FROM ".$opzoektabel." WHERE Verwijderd=0 AND Volgnummer <> '$id' AND ((Begintijd >= '$start_time' AND Begintijd < '$end_time') OR (Eindtijd > '$start_time' AND Eindtijd <= '$end_time') OR (Begintijd <= '$start_time' AND Eindtijd >= '$end_time')) AND Datum = '$date_db' AND Boot_ID = '$boat_id';";		$result = mysql_query($query);		if (!$result) {			$returnText .= "Het controleren van uw inschrijving is mislukt.<br />";		} else {			$rows_aff = mysql_affected_rows($bisdblink);			if ($rows_aff > 0) {				if ($e == 0) {					$fail_msg .= "Uw inschrijving van $boat is mislukt omdat deze conflicteert met een al bestaande inschrijving.<br />";				} else {					$returnText .= "Uw inschrijving van $boat is mislukt omdat deze conflicteert met een al bestaande inschrijving.<br />";					$fail_partial = true;					$fail_partial_cnt += 1;				}			}		}				// Ingeval van het bewerken van een bestaande inschrijving, eerst oude uit DB verwijderen		$mail_gestuurd = false;		if ($id > 0 && !$again) {			if ($fail_msg == "") {				$email_to = "";				// haal gegevens niet uit form maar uit DB, om fraude te voorkomen				$query2 = "SELECT Email, Boot_ID, Datum, Begintijd, Spits FROM ".$opzoektabel." WHERE Volgnummer='$id';";				$result2 = mysql_query($query2);				if ($result2) {					$row = mysql_fetch_assoc($result2);					$email_to = $row['Email'];					$boot_id = $row['Boot_ID'];					// retrieve boat name					$query_bootnaam = "SELECT Naam FROM boten WHERE ID=$boot_id;";					$result_bootnaam = mysql_query($query_bootnaam);					$row_bootnaam = mysql_fetch_assoc($result_bootnaam);					$boot = $row_bootnaam['Naam'];					//					$db_datum = $row['Datum'];					$date_tmp = strtotime($db_datum);					$date_sh = strftime('%A %d-%m-%Y', $date_tmp);					$starttijd = $row['Begintijd'];					$spitsnr = $row['Spits'];					if ($spitsnr > 0) {						$message = "Uw spitsblok van '$boot' op $date_sh vanaf ".substr($starttijd, 0, 5)." is zojuist bevestigd.";					} else {						$message = "Uw inschrijving van '$boot' op $date_sh vanaf ".substr($starttijd, 0, 5)." is zojuist gewijzigd.";					}				}				$query = "UPDATE ".$opzoektabel." SET Verwijderd=1 WHERE Volgnummer='$id';";				$result = mysql_query($query);				if (!$result) {					$returnText .= "Het verwijderen van de oude inschrijving is mislukt.<br />";				} else {					if (SendEmail($email_to, "Wijziging of bevestiging inschrijving", $message)) {						$mail_gestuurd = true;					}				}			}		}				// Het inserten		if ($fail_msg == "") {			if (!$fail_partial) {				// inschrijving wordt ingevoerd of gewijzigd				$today_db = date('Y-m-d');				$team_name = addslashes($team_name); // speciale tekens in ploegnaam "redden"				$team_name = preg_replace("/\"/", "'", $team_name); // dubbele quotes omzetten naar enkele, omdat anders het tooltip-scriptje gek wordt				$query = "INSERT INTO ".$opzoektabel." (Datum, Inschrijfdatum, Begintijd, Eindtijd, Boot_ID, Pnaam, Ploegnaam, Email, MPB, Spits, Controle) VALUES ('$date_db', '$today_db', '$start_time', '$end_time', '$boat_id', '$name', \"$team_name\", '$email', '$mpb', '0', '$controle');";				$result = mysql_query($query);				if (!$result) {					$returnText .= "Uw inschrijving is mislukt.<br />";				} else {					$date_tmp = strtotime($date_db);					$date_sh = strftime('%A %d-%m-%Y', $date_tmp);					$returnText .= "Beste $name, uw inschrijving van '$boat' op $date_sh van ".substr($start_time, 0, 5)." tot ".substr($end_time, 0, 5)." is gelukt.<br />";					if ($controle) {						$returnText .= "NB: uw inschrijving is vanwege MPB gelogd en zal door het opgegeven bestuurslid worden gecontroleerd.<br />";					}					if ($mail_gestuurd) {						$returnText .= "NB: er is ter controle een e-mail gestuurd aan de oorspronkelijke inschrijver.<br />";					}					if ($koudwaterprotocol && ($themonth < 4 || $themonth > 9) && $cat != "Ergometers en bak") {						$returnText .= "<span style='font-size:150%'><strong>LET OP!</strong> Wees in de winter voorzichtig i.v.m. het koude water. Heeft u het <a href='http://www.hunze.nl/drupal/sites/default/files/Koudwaterprotocol.pdf' target='_blank'>koudwater-protocol</a> al gelezen?</span>";					}				}			} else {				$returnText .=  "Let op: &eacute;&eacute;n of meer van de inschrijvingen in uw blok zijn mislukt.<br />";			}		} else {			$returnText .=  "Uw inschrijving is mislukt vanwege de volgende fout(en):<br />" . $fail_msg;		}	} // end for-loop ergo_lo - ergo_hi	$returnText .= "</p>";		// TODO: naar de AJAX-methode?	// if (!$from_api) {		// $returnText .= "<a href=\"./index.php?date_to_show=$date&amp;start_time_to_show=$start_time&amp;cat_to_show=$cat_to_show&amp;grade_to_show=$grade_to_show\">Klik hier om terug te gaan naar het inschrijfblad&gt;&gt;</a><br />";		// // link t.b.v. nog een inschrijving met dezelfde gegevens, m.u.v. boot		// $query = "SELECT Volgnummer FROM ".$opzoektabel." WHERE Verwijderd=0 AND Datum='$date_db' AND Begintijd='$start_time' AND Boot_ID='$boat_id';";		// $result = mysql_query($query);		// if ($result) {			// $row = mysql_fetch_assoc($result);			// $id_again = $row['Volgnummer'];			// $returnText .= "<a href=\"./inschrijving.php?id=$id_again&amp;again=1&amp;date=$date&amp;cat_to_show=$cat_to_show&amp;grade_to_show=$grade_to_show&amp;time_to_show=$start_time\">Klik hier om een inschrijving te maken van een andere boot met dezelfde gegevens&gt;&gt;</a>";		// }	// }		mysql_close($bisdblink);		return $returnText;}?>